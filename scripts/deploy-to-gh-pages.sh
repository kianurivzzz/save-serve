#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–ø–∫–∏ landing –≤ –≤–µ—Ç–∫—É gh-pages
# –ê–≤—Ç–æ—Ä: nkarasyov

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if [ -n "$(git status --porcelain)" ]; then
  echo "‚ö†Ô∏è  –í —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º."
  exit 1
fi

# –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
echo "üìå –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ landing
if [ ! -d "landing" ]; then
  echo "‚ùå –ü–∞–ø–∫–∞ landing –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞."
  exit 1
fi

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è..."

# –°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
TEMP_DIR=$(mktemp -d)
echo "üìÅ –°–æ–∑–¥–∞–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $TEMP_DIR"

# –ö–æ–ø–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ landing –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cp -r landing/* "$TEMP_DIR"
echo "üìã –§–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ landing —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –≤–µ—Ç–∫—É gh-pages. –°–æ–∑–¥–∞—ë—Ç –µ–µ, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if git show-ref --verify --quiet refs/heads/gh-pages; then
  echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≤–µ—Ç–∫—É gh-pages"
  git checkout gh-pages
else
  echo "üîÑ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ç–∫—É gh-pages"
  git checkout --orphan gh-pages
  git rm -rf . > /dev/null
fi

# –û—á–∏—â–∞–µ—Ç –≤–µ—Ç–∫—É gh-pages
echo "üóëÔ∏è –û—á–∏—â–∞–µ–º –≤–µ—Ç–∫—É gh-pages"
find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} \;

# –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
echo "üìã –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–µ–Ω—å –≤–µ—Ç–∫–∏ gh-pages"
cp -r "$TEMP_DIR"/* .

# –î–æ–±–∞–≤–ª—è–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –≤ git
echo "‚ûï –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ git"
git add .

# –ö–æ–º–º–∏—Ç–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üíæ –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç"
git commit -m "Deploy to GitHub Pages: $(date)"

# –ü—É—à–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
echo "üöÄ –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ç–∫—É gh-pages"
git push -u origin gh-pages

# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –≤–µ—Ç–∫—É
echo "üîÑ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ –≤–µ—Ç–∫—É $CURRENT_BRANCH"
git checkout "$CURRENT_BRANCH"

# –£–¥–∞–ª—è–µ—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"
rm -rf "$TEMP_DIR"

echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –°–∞–π—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://$(git config --get remote.origin.url | sed 's/.*github.com[:\/]\([^\/]*\/[^\/]*\).*/\1/' | sed 's/\.git$//' | sed 's/\//.github.io\//')"
echo "‚ö†Ô∏è  –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞."
echo ""
echo "üìù –ù–µ –∑–∞–±—É–¥—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å GitHub Pages –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:"
echo "   1. –û—Ç–∫—Ä–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ GitHub"
echo "   2. –ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª 'Pages'"
echo "   3. –í —Ä–∞–∑–¥–µ–ª–µ 'Build and deployment' –≤—ã–±–µ—Ä–∏ 'Deploy from a branch'"
echo "   4. –í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ç–∫—É 'gh-pages' –∏ –ø–∞–ø–∫—É '/ (root)'"
echo "   5. –ù–∞–∂–º–∏—Ç–µ 'Save'"
